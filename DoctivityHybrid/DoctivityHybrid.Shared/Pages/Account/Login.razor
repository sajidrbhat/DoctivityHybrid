@page "/login"

@attribute [ExcludeFromInteractiveRouting]

@using System.ComponentModel.DataAnnotations
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

<style type="text/css">
    /* --- MudBlazor Form Field Wrapper --- */
    .mud-form-field {
        margin-bottom: 24px;
        display: flex;
        flex-direction: column;
    }

    /* --- Label --- */
    .mud-label {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 6px;
        color: rgba(0, 0, 0, 0.75);
    }

    /* --- Input Styling (like MudTextField) --- */
    .mud-input {
        padding: 10px 14px;
        border: 1px solid #cfcfcf;
        border-radius: 8px;
        font-size: 15px;
        outline: none;
        transition: 0.2s ease;
        background-color: white;
    }

        /* On focus (blue glow like MudBlazor) */
        .mud-input:focus {
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.2);
        }

        /* When invalid */
        .mud-input.input-validation-error {
            border-color: #d32f2f;
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.15);
        }

    /* --- Validation Message --- */
    .mud-error {
        color: #d32f2f;
        font-size: 13px;
        margin-top: 4px;
    }

    /* --- Button styling (MudBlazor Primary Button) --- */
    .mud-button {
        width: 100%;
        padding: 10px 14px;
        background-color: #1976d2;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s ease;
    }

        /* Hover & Active */
        .mud-button:hover {
            background-color: #115293;
        }

        .mud-button:active {
            background-color: #0d3c80;
        }

        /* Disabled state */
        .mud-button:disabled {
            background-color: #90caf9;
            cursor: not-allowed;
        }

</style>

<MudGrid Justify="Justify.Center" Class="mt-10">
    <MudItem xs="12" sm="6" md="4">
        <MudPaper Class="pa-6 rounded-lg">

            <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-4">
                Login
            </MudText>

            <!-- EDITFORM -->
            <EditForm Model="@model" OnValidSubmit="HandleValidSubmit" FormName="login-form">
                <DataAnnotationsValidator />

                <!-- Username -->
                <div class="mud-form-field">
                    <label class="mud-label">Username</label>
                    <InputText @bind-Value="model.Username" class="mud-input" />
                    <ValidationMessage For="@(() => model.Username)" class="mud-error" />
                </div>

                <!-- Password -->
                <div class="mud-form-field">
                    <label class="mud-label">Password</label>
                    <InputText type="password" @bind-Value="model.Password" class="mud-input" />
                    <ValidationMessage For="@(() => model.Password)" class="mud-error" />
                </div>

                <!-- Login button -->
                <div>
                    <button type="submit" class="mud-button">
                        Login
                    </button>
                </div>

            </EditForm>




            @if (!string.IsNullOrWhiteSpace(errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">
                    @errorMessage
                </MudAlert>
            }

        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private MudForm form;
    private bool isValid;
    private bool isLoading;
    private string errorMessage;

    [SupplyParameterFromForm(FormName = "login-form")]
    public LoginModel model { get; set; } = new();

    public class LoginModel
    {
        [Required(ErrorMessage = "Username is required")]
        public string Username { get; set; }

        [Required(ErrorMessage = "Password is required")]
        public string Password { get; set; }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
    }

    private async Task HandleInvalidSubmit()
    {
        errorMessage = "Please fix the validation errors.";
    }

    private async Task HandleValidSubmit()
    {
        errorMessage = null;
        isLoading = true;

        try
        {
            var result = await AuthService.LoginAsync(model.Username, model.Password);

            if (!result.IsSuccess)
            {
                errorMessage = result.Message;
                return;
            }

            // Platform login (optional)
            var loggedInUser = result.data;
            var platformLogin = await AuthService.PlatformLoginAsync(loggedInUser);

            if (!platformLogin.IsSuccess)
            {
                errorMessage = platformLogin.Message;
                return;
            }

            // Success → navigate
            NavigationManager.NavigateTo("/", replace: true);
        }
        catch (Exception ex)
        {
            errorMessage = "Login failed: " + ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }
}
